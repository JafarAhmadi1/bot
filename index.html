<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</title>
    
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 2em auto; background-color: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 0; color: #0077cc; }
        p { font-size: 16px; color: #606770; }
        
        .action-button { display: inline-block; padding: 12px 25px; margin: 5px; border: none; border-radius: 8px; background-color: #0077cc; color: #ffffff; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #005fa3; }
        .action-button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .secondary-button { background-color: #6c757d; }
        .secondary-button:hover:not(:disabled) { background-color: #5a6268; }
        .button-container { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;}

        input[type="file"] { display: none; }
        #frame-selection { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        #output { margin-top: 1.5em; padding: 1em; background-color: #f7f7f7; border-radius: 8px; word-wrap: break-word; min-height: 50px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        #preview-container img { max-width: 80%; height: auto; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 1em; }
        canvas { display: none; }
        .counter-p { margin-top: 5px; font-size: 12px; color: #888; }
    </style>
</head>
<body>
    
    <div class="container">
        <h1 style="margin-bottom: 5px;">ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h1>
        
        <div id="stats-container" style="display: none; margin-bottom: 15px;">
             <p id="web-counter-container" class="counter-p" style="display: none;">
                ØªØ¹Ø¯Ø§Ø¯ Ø´Ø±Ú©Øª Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙˆØ¨: <span id="visitor-count-web">...</span>
            </p>
            <p id="total-counter-container" class="counter-p" style="display: none;">
                ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø´Ø±Ú©Øª Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† Ù¾ÙˆÛŒØ´: <strong id="visitor-count-total" style="color: #333;">...</strong>
            </p>
        </div>

        <div id="initial-choice-container" style="display: none;">
            <p style="font-size: 16px; background-color: #e7f3fe; color: #0c5460; padding: 15px; border-radius: 8px; border: 1px solid #bde5f8;">
                <br>
               ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ùˆ Ú©ÛŒÙÛŒØª Ø¨Ù‡ØªØ±ØŒ Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ÛŒØ¯ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ø³Ø±ÛŒØ¹ ÙˆØ¨ Ù…Ù†ØªÙ‚Ù„ Ø´ÙˆÛŒØ¯ØŸ  
            </p>
            
            <div class="button-container">
                <button id="open-web-version-btn" class="action-button">Ø¨Ù„Ù‡</button>
                <button id="continue-no-btn" class="action-button secondary-button">Ø®ÛŒØ±</button>
            </div>
        </div>

        <div id="main-app-container" style="display: none;">
            <div id="selection-area">
                <p>Ø³Ù„Ø§Ù… Ø¨Ù‡ Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§ Ø®ÙˆØ´ Ø¢ÙˆÙ…Ø¯ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø­Ù…Ø§ÛŒØª Ø§Ø² <b>Ø§ÛŒØ±Ø§Ù† Ø¬Ø§Ù†</b>** Ùˆ Ø¨Ø±Ø§ÛŒ ØªØ²Ø¦ÛŒÙ† ØªØµÙˆÛŒØ±ØªÙˆÙ† Ø¨Ø§ Ù¾Ø±Ú†Ù… Ø³Ù‡ Ø±Ù†Ú¯ Ø§ÛŒØ±Ø§Ù† Ø¹Ø²ÛŒØ²ØŒ Ù„Ø·ÙØ§ ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØªÙˆÙ† Ø±Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>
                <div>
                    <label for="fileInput" class="action-button" id="upload-label">Û±. Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±</label>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div id="frame-selection" style="display: none;"></div>
            </div>
            
            <canvas id="imageCanvas"></canvas>

            <div id="preview-container" style="display: none;">
                <h3>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</h3>
                <img id="preview-image" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù‚Ø§Ø¨">
                <p>Ø¢ÛŒØ§ Ø§Ø² Ù†ØªÛŒØ¬Ù‡ Ø±Ø§Ø¶ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ</p>
                <div>
                    <button id="cancel-preview-btn" class="action-button secondary-button">ğŸ”„ Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø±</button>
                    <button id="confirm-upload-btn" class="action-button">âœ… Ø¨Ù„Ù‡ØŒ Ø¯Ø§Ù†Ù„ÙˆØ¯Ø´ Ú©Ù†</button>
                </div>
            </div>

            <div id="output"><p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p></div>
            <p id="final-link" style="margin-top: 10px;"></p>
            <button id="restart-button" class="action-button secondary-button" style="display: none;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Ù…Ù‚Ø§Ø¯ÛŒØ± Ø«Ø§Ø¨Øª ---
    const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/";
    const webAppUrl = "https://jafarahmadi1.github.io/bot/";
    const FRAMES_DATA = [
        { label: "ğŸ–¼ï¸ Ù‚Ø§Ø¨ Û±", url: "frames/Parcham_Frame_1.png" },
        { label: "ğŸ–¼ï¸ Ù‚Ø§Ø¨ Û²", url: "frames/Parcham_Frame_2.png" },
        { label: "ğŸ–¼ï¸ Ù‚Ø§Ø¨ Û³", url: "frames/Parcham_Frame_3.png" },
        { label: "ğŸ´ Ù‚Ø§Ø¨ Ù…Ø­Ø±Ù…", url: "frames/Parcham_Bala_M3.png" }
    ];

    // --- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ---
    // (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    const fileInput = document.getElementById('fileInput');
    const outputDiv = document.getElementById('output');
    const canvas = document.getElementById('imageCanvas');
    const restartButton = document.getElementById('restart-button');
    const finalLinkContainer = document.getElementById('final-link');
    const previewContainer = document.getElementById('preview-container');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const initialChoiceContainer = document.getElementById('initial-choice-container');
    const mainAppContainer = document.getElementById('main-app-container');
    const continueNoBtn = document.getElementById('continue-no-btn');
    const openWebVersionBtn = document.getElementById('open-web-version-btn');
    const statsContainer = document.getElementById('stats-container');
    const webCounterContainer = document.getElementById('web-counter-container');
    const totalCounterContainer = document.getElementById('total-counter-container');
    const visitorCountWebSpan = document.getElementById('visitor-count-web');
    const visitorCountTotalSpan = document.getElementById('visitor-count-total');

    // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª ---
    let finalImageBlob = null;
    let isEitaaEnv = false;
    let currentSource = 'web';
    let eitaaInitDataString = null;
    let selectedFrameLabel = null; // <<< NEW: Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡

    // --- ØªÙˆØ§Ø¨Ø¹ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
    async function incrementCount() {
        try {
            const sourceForCount = eitaaInitDataString ? 'eitaa' : currentSource;
            await fetch(`${workerUrl}increment?source=${sourceForCount}`, { method: 'POST' });
            await fetchAndDisplayCounts();
        } catch (error) {
            console.error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ${currentSource}:`, error);
        }
    }

    async function fetchAndDisplayCounts() {
        statsContainer.style.display = 'block';
        try {
            const response = await fetch(`${workerUrl}count`, { method: 'GET' });
            if (!response.ok) throw new Error('Ù¾Ø§Ø³Ø® Ø´Ø¨Ú©Ù‡ ØµØ­ÛŒØ­ Ù†Ø¨ÙˆØ¯');
            const data = await response.json();
            totalCounterContainer.style.display = 'block';
            visitorCountTotalSpan.textContent = parseInt(data.total).toLocaleString('fa');
            if (currentSource === 'web' && !eitaaInitDataString) {
                webCounterContainer.style.display = 'block';
                visitorCountWebSpan.textContent = parseInt(data.web).toLocaleString('fa');
            } else {
                 webCounterContainer.style.display = 'none';
            }
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²Ø¯ÛŒØ¯:", error);
            visitorCountTotalSpan.textContent = 'Ù†Ø§Ù…Ø´Ø®Øµ';
            visitorCountWebSpan.textContent = 'Ù†Ø§Ù…Ø´Ø®Øµ';
        }
    }

    // --- ØªØ´Ø®ÛŒØµ Ù…Ø­ÛŒØ· Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
    const urlParams = new URLSearchParams(window.location.search);
    const eitaaDataFromUrl = urlParams.get('eitaa_data');
    if (eitaaDataFromUrl) {
        eitaaInitDataString = decodeURIComponent(eitaaDataFromUrl);
    }
    if (window.Eitaa && window.Eitaa.WebApp && window.Eitaa.WebApp.platform && window.Eitaa.WebApp.platform !== 'unknown') {
        isEitaaEnv = true;
        currentSource = 'eitaa';
        window.Eitaa.WebApp.ready();
        window.Eitaa.WebApp.expand();
        eitaaInitDataString = window.Eitaa.WebApp.initData; // <<< MODIFIED: Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØªØ§ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
        initialChoiceContainer.style.display = 'block';
    } else {
        isEitaaEnv = false;
        currentSource = 'web';
        mainAppContainer.style.display = 'block';
    }
    fetchAndDisplayCounts();
    
    // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
    openWebVersionBtn.addEventListener('click', function() {
        if (isEitaaEnv && window.Eitaa.WebApp) {
            const initData = window.Eitaa.WebApp.initData;
            const finalUrl = `${webAppUrl}?eitaa_data=${encodeURIComponent(initData)}`;
            window.Eitaa.WebApp.openLink(finalUrl);
        }
    });
    continueNoBtn.addEventListener('click', () => {
        initialChoiceContainer.style.display = 'none';
        mainAppContainer.style.display = 'block';
    });
    fileInput.addEventListener('change', handleFileSelect);
    restartButton.addEventListener('click', resetApp);
    confirmUploadBtn.addEventListener('click', handleConfirmUpload);
    document.getElementById('cancel-preview-btn').addEventListener('click', cancelPreview);

    // --- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    async function handleConfirmUpload() {
        previewContainer.style.display = 'none';
        outputDiv.style.display = 'block';
        if (!finalImageBlob) {
            outputDiv.innerHTML = `<p class="error">Ø®Ø·Ø§: ØªØµÙˆÛŒØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>`;
            return;
        }

        await incrementCount();

        if (isEitaaEnv) {
             // Ø¯Ø± Ù…Ø­ÛŒØ· Ø§ÛŒØªØ§ØŒ Ù‡Ù… Ø¹Ú©Ø³ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù† Ùˆ Ù‡Ù… Ù„Ø§Ú¯ Ø¨ÙØ±Ø³Øª
            uploadBlobToBaleViaWorker(finalImageBlob);
            if (eitaaInitDataString) {
                sendEitaaDataForLogging(eitaaInitDataString, selectedFrameLabel);
            }
        } else {
            // Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙˆØ¨ØŒ Ø¹Ú©Ø³ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†
            downloadBlobDirectly(finalImageBlob);
            // Ùˆ Ø§Ú¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒØªØ§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªØŒ Ù„Ø§Ú¯ Ø¨ÙØ±Ø³Øª
            if (eitaaInitDataString) {
                // <<< MODIFIED: Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù… Ù‚Ø§Ø¨ Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ >>>
                sendEitaaDataForLogging(eitaaInitDataString, selectedFrameLabel);
            }
        }
    }
    
    function downloadBlobDirectly(blob) {
        try {
            const fileName = `Parcham_Bala_${Date.now()}.jpg`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none'; a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            outputDiv.innerHTML = `<p class="success">âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ù…Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.</p>`;
            restartButton.style.display = 'inline-block';
        } catch (error) {
            outputDiv.innerHTML = `<p class="error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯: ${error.message}</p>`;
        }
    }
    
    async function uploadBlobToBaleViaWorker(imageBlob) {
        outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯...";
        confirmUploadBtn.disabled = true;
        try {
            const formData = new FormData();
            formData.append("file", imageBlob, `Parcham_Bala_${Date.now()}.jpg`);
            const response = await fetch(workerUrl, { method: "POST", body: formData });
            
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.details || result.error || "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±.");
            
            outputDiv.innerHTML = `<p class="success">âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆÙÙ‚.</p>`;
            const downloadUrl = result.url;
            finalLinkContainer.innerHTML = `<a href="${downloadUrl}" target="_blank" class="action-button">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</a>`;
            const EitaaApp = window.Eitaa.WebApp;
            EitaaApp.MainButton.setText("Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±").onClick(() => EitaaApp.openLink(downloadUrl, {try_instant_view: true})).show();
            restartButton.style.display = 'inline-block';
        } catch (error) {
            outputDiv.innerHTML = `<p class="error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ${error.message}</p>`;
        } finally {
            confirmUploadBtn.disabled = false;
        }
    }

    // <<< MODIFIED: ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ù„Ø§Ú¯ Ø­Ø§Ù„Ø§ Ù†Ø§Ù… Ù‚Ø§Ø¨ Ø±Ø§ Ù‡Ù… Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙˆØ±ÙˆØ¯ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ >>>
    async function sendEitaaDataForLogging(dataString, frameLabel) {
        console.log("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‚Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª...");
        try {
            const response = await fetch(`${workerUrl}log-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // <<< MODIFIED: Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù… Ù‚Ø§Ø¨ Ø¯Ø± Ø¨Ø¯Ù†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª >>>
                body: JSON.stringify({ 
                    eitaa_data: dataString,
                    frame_label: frameLabel 
                })
            });
            if (response.ok) {
                console.log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.");
            } else {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª.");
            }
        } catch (error) {
            console.error("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª:", error);
        }
    }

    // --- Ø³Ø§ÛŒØ± ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
    function handleFileSelect(event) { if (event.target.files.length === 0) return; const userFile = event.target.files[0]; document.getElementById('upload-label').style.display = 'none'; outputDiv.innerHTML = `<p>Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>`; showFrameSelection(userFile); }
    function showFrameSelection(userFile) { const frameSelectionDiv = document.getElementById('frame-selection'); frameSelectionDiv.innerHTML = '<h3>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</h3>'; FRAMES_DATA.forEach(frame => { const button = document.createElement('button'); button.innerText = frame.label; button.className = 'action-button'; button.onclick = () => generatePreview(userFile, frame); frameSelectionDiv.appendChild(button); }); frameSelectionDiv.style.display = 'block'; }
    
    // <<< MODIFIED: Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø§ Ú©Ù„ Ø¢Ø¨Ø¬Ú©Øª frame Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ >>>
    async function generatePreview(userFile, frame) { 
        document.getElementById('selection-area').style.display = 'none'; 
        outputDiv.style.display = 'block'; 
        outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª â€ŒØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ..."; 
        try { 
            // <<< NEW: Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ >>>
            selectedFrameLabel = frame.label;
            finalImageBlob = await createFramedImage(userFile, frame.url); 
            const previewUrl = URL.createObjectURL(finalImageBlob); 
            document.getElementById('preview-image').src = previewUrl; 
            outputDiv.style.display = 'none'; 
            previewContainer.style.display = 'block'; 
        } catch (error) { 
            outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`; 
            restartButton.style.display = 'inline-block'; 
        } 
    }

    function cancelPreview() { previewContainer.style.display = 'none'; document.getElementById('selection-area').style.display = 'block'; outputDiv.style.display = 'block'; outputDiv.innerHTML = '<p>ÛŒÚ© Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>'; if (document.getElementById('preview-image').src) { URL.revokeObjectURL(document.getElementById('preview-image').src); } finalImageBlob = null; selectedFrameLabel = null; /* <<< NEW >>> */ }
    async function createFramedImage(userImageFile, frameImageUrl) { const ctx = canvas.getContext('2d'); const loadImage = (src) => new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => resolve(img); img.onerror = (err) => reject(new Error(" Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± ÛŒØ§ Ù‚Ø§Ø¨.")); img.src = src; }); const userImageUrl = URL.createObjectURL(userImageFile); try { const [userImg, frameImg] = await Promise.all([loadImage(userImageUrl), loadImage(frameImageUrl)]); const size = 512; canvas.width = size; canvas.height = size; const userAspect = userImg.width / userImg.height; let sx, sy, sWidth, sHeight; if (userAspect > 1) { sHeight = userImg.height; sWidth = sHeight; sx = (userImg.width - sWidth) / 2; sy = 0; } else { sWidth = userImg.width; sHeight = sWidth; sx = 0; sy = (userImg.height - sHeight) / 2; } ctx.drawImage(userImg, sx, sy, sWidth, sHeight, 0, 0, size, size); ctx.drawImage(frameImg, 0, 0, size, size); return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.90)); } finally { URL.revokeObjectURL(userImageUrl); } }
    
    function resetApp() { 
        finalImageBlob = null; 
        selectedFrameLabel = null; // <<< NEW: Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ù‚Ø§Ø¨
        if (document.getElementById('preview-image').src) { URL.revokeObjectURL(document.getElementById('preview-image').src); } 
        fileInput.value = ''; 
        const selectionArea = document.getElementById('selection-area'); 
        selectionArea.style.display = 'block'; 
        document.getElementById('upload-label').style.display = 'inline-block'; 
        document.getElementById('frame-selection').innerHTML = ''; 
        document.getElementById('frame-selection').style.display = 'none'; 
        previewContainer.style.display = 'none'; 
        outputDiv.style.display = 'block'; 
        outputDiv.innerHTML = '<p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>'; 
        finalLinkContainer.innerHTML = ''; 
        restartButton.style.display = 'none'; 
        if (isEitaaEnv) { window.Eitaa.WebApp.MainButton.hide(); } 
    }
});
</script>

</body>
</html>
