<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>آپلود عکس به ImageKit.io</title>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: right; padding: 2em; max-width: 600px; margin: auto; }
    #output { margin-top: 1em; word-wrap: break-word; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    button { padding: 0.5em 1em; cursor: pointer; }
    input[type="file"] { border: 1px solid #ccc; padding: 0.5em; }
    a { color: #0077cc; }
  </style>
</head>
<body>

  <h2>آپلود عکس به ImageKit.io از طریق GitHub و Cloudflare Worker</h2>

  <form id="uploadForm">
    <input type="file" id="fileInput" accept="image/*" required>
    <br><br>
    <button type="submit">آپلود کن</button>
  </form>

  <div id="output"></div>

  <script>
    // --- لطفاً این دو متغیر را با مقادیر خودتان پر کنید ---
    const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/"; // آدرس کامل ورکر خودتان را اینجا بگذارید
    const imagekitPublicKey = "public_93KUnZJ92ve8aZ91xGGC7/AXbvo="; // کلید عمومی خودتان را اینجا بگذارید
    const imagekitUrlEndpoint = "https://ik.imagekit.io/kmrxk5bhgx"; // آدرس URL-Endpoint خودتان را اینجا بگذارید

    document.getElementById("uploadForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const outputDiv = document.getElementById("output");
      const fileInput = document.getElementById("fileInput");

      if (fileInput.files.length === 0) {
        outputDiv.innerHTML = `<p class="error">لطفاً یک تصویر انتخاب کنید.</p>`;
        return;
      }
      
      const file = fileInput.files[0];

      // بررسی مقادیر اولیه
      if (workerUrl === "https://eite2bale.jafar-ahmadi658.workers.dev/" || imagekitPublicKey === "public_93KUnZJ92ve8aZ91xGGC7/AXbvo=" || imagekitUrlEndpoint === "https://ik.imagekit.io/kmrxk5bhgx") {
          outputDiv.innerHTML = `<p class="error">لطفاً مقادیر لازم را در کد اسکریپت تنظیم کنید.</p>`;
          return;
      }

      outputDiv.innerHTML = "در حال دریافت توکن امنیتی...";

      try {
        // ۱. دریافت توکن، زمان انقضا و امضای دیجیتال از ورکر
        const authResponse = await fetch(workerUrl);
        if (!authResponse.ok) {
          throw new Error("ارتباط با ورکر برای دریافت توکن امنیتی ناموفق بود.");
        }
        const authData = await authResponse.json();

        outputDiv.innerHTML = "توکن دریافت شد. در حال آپلود تصویر...";

        // ۲. ساخت فرم دیتا و ارسال مستقیم به ImageKit.io
        const formData = new FormData();
        formData.append("file", file);
        formData.append("publicKey", imagekitPublicKey);
        formData.append("signature", authData.signature);
        formData.append("expire", authData.expire);
        formData.append("token", authData.token);
        formData.append("fileName", file.name); // نام فایل اصلی را حفظ می‌کنیم

        const uploadResponse = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
          method: "POST",
          body: formData
        });
        
        const result = await uploadResponse.json();

        if (uploadResponse.ok) {
          const publicLink = result.url;
          outputDiv.innerHTML = `<p class="success">✅ لینک تصویر شما:</p><a href="${publicLink}" target="_blank">${publicLink}</a>`;
        } else {
          // اگر خود ImageKit خطا داد، پیامش را نمایش می‌دهیم
          throw new Error(`خطا از ImageKit.io: ${result.message}`);
        }

      } catch (error) {
        console.error("خطای کامل:", error);
        outputDiv.innerHTML = `<p class="error">❌ ${error.message}</p>`;
      }
    });
  </script>

</body>
</html>
