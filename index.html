<!-- ุฏุฑ ุจุฎุด <script> ูุงู HTML ุดูุง -->
<script>
    // ... (ุชูุงู ฺฉุฏูุง ุฏฺฏุฑ ุดูุง: DOM Elements, FRAME_IMAGE_URLS, etc.) ...
    const CLOUDFLARE_WORKER_URL = 'https://red-moon-03a5.jafar-ahmadi658.workers.dev/'; // ุขุฏุฑุณ Worker ุดูุง

    // ... (ุชูุงุจุน showFrameSelection ู loadImage ุจุฏูู ุชุบุฑ) ...

    async function createFramedImage(userImageUrl, frameUrl) {
        const ctx = canvas.getContext('2d');
        // ... (ููุทู loadImage ู try...catch ุดูุง ฺฉุงูู ู ุตุญุญ ุงุณุช) ...

        try {
            const [userImg, frameImg] = await Promise.all([loadImage(userImageUrl), loadImage(frameUrl)]);

            // ... (ููุทู ุจุฑุด ู ฺฉุดุฏู ุฑู canvas ุดูุง) ...
            ctx.drawImage(userImg, x, y, drawWidth, drawHeight);
            ctx.drawImage(frameImg, 0, 0, size, size);

            // --- ุดุฑูุน ุชุบุฑุงุช ฺฉูุฏ ---

            // 1. ุฏุฑุงูุช ุชุตูุฑ ููุง ุจู ุตูุฑุช Blob (ุจูููโุชุฑ ุงุฒ Data URL ุจุฑุง ุขูพููุฏ)
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    statusDiv.innerText = "ุฎุทุง ุฏุฑ ุณุงุฎุช ุชุตูุฑ ููุง.";
                    return;
                }

                // 2. ุณุงุฎุช FormData ุจุฑุง ุงุฑุณุงู ุจู Worker
                const formData = new FormData();
                formData.append('finalImage', blob, 'parcham-bala-profile.png');
                
                // ุงุทูุงุนุงุช ุงุถุงู ฺฉู ููฺฉู ุงุณุช ุฏุฑ ุขูุฏู ูุงุฒ ุดูุฏ (ูุซูุง ุดูุงุณู ฺฉุงุฑุจุฑ)
                // formData.append('userId', 'some_user_id'); 

                statusDiv.innerText = "โ ุชุตูุฑ ุณุงุฎุชู ุดุฏ! ุฏุฑ ุญุงู ุงุฑุณุงู ุจู ุฑุจุงุช...";

                // 3. ุงุฑุณุงู ุชุตูุฑ ููุง ุจู Cloudflare Worker
                try {
                    const response = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(`ุฎุทุง ุณุฑูุฑ: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        statusDiv.innerText = "๐ ุจุง ููููุช ุจู ุฑุจุงุช ุดูุง ุงุฑุณุงู ุดุฏ! ูโุชูุงูุฏ ุขู ุฑุง ุฏุฑ ุจูู ูุดุงูุฏู ฺฉูุฏ.";
                        // ูโุชูุงูุฏ ุงูุฌุง ฺฉ ุฏฺฉูู ุจุฑุง ุจุงุฒ ฺฉุฑุฏู ุจูู ูุฑุงุฑ ุฏูุฏ
                        // ุง ูพุงู ุจุฑุง ุชุดูู ฺฉุงุฑุจุฑ ุจู ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ
                    } else {
                        throw new Error(result.error || 'ุฎุทุง ูุงุดูุงุฎุชู ุงุฒ ุณูุช ุณุฑูุฑ');
                    }

                } catch (uploadError) {
                    console.error("Upload Error:", uploadError);
                    statusDiv.innerText = `ุฎุทุง ุฏุฑ ุงุฑุณุงู ุจู ุฑุจุงุช: ${uploadError.message}`;
                }

            }, 'image/png');

            // --- ูพุงุงู ุชุบุฑุงุช ฺฉูุฏ ---

            // ููุงุด ูููุช ูุชุฌู ุฏุฑ ุตูุญู ูุจ (ุงู ุจุฎุด ูโุชูุงูุฏ ุจุงู ุจูุงูุฏ)
            const finalImageDataUrl = canvas.toDataURL('image/png');
            resultImage.src = finalImageDataUrl;
            downloadLink.href = finalImageDataUrl;
            resultContainer.style.display = 'block';

        } catch (error) {
            // ... (ุจุฎุด ูุฏุฑุช ุฎุทุง ุดูุง) ...
        }
    }
</script>
