// تعریف هدرهای CORS برای استفاده مجدد
const corsHeaders = {
  "Access-Control-Allow-Origin": "*", // به همه دامنه‌ها اجازه دسترسی می‌دهد
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type",
};

export default {
  async fetch(request) {
    // پاسخ به درخواست‌های OPTIONS برای بررسی CORS (preflight)
    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    if (request.method === "POST") {
      const contentType = request.headers.get("content-type") || "";

      if (!contentType.includes("multipart/form-data")) {
        return new Response(JSON.stringify({ error: "نوع محتوا باید multipart/form-data باشد" }), {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      const formData = await request.formData();
      const file = formData.get("file");

      if (!file || typeof file === "string") {
        return new Response(JSON.stringify({ error: "فایلی برای آپلود ارسال نشده است" }), {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      // ساخت یک فرم جدید برای ارسال به PostImages
      const uploadForm = new FormData();
      // نام فیلد در API داخلی PostImages 'upload[]' است
      uploadForm.append("upload[]", file, file.name);

      try {
        // ارسال درخواست به PostImages با هدرهای مناسب
        const postImagesResponse = await fetch("https://postimages.org/json/rr", {
          method: "POST",
          body: uploadForm,
          headers: {
            // این هدرها باعث می‌شوند درخواست شما شبیه به یک درخواست واقعی از مرورگر به نظر برسد
            "Referer": "https://postimages.org/",
            "Accept": "application/json",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
          }
        });

        // ۱. بررسی می‌کنیم که آیا پاسخ موفقیت‌آمیز است یا نه (کدهای 2xx)
        if (!postImagesResponse.ok) {
          // اگر موفق نبود، متن خطا را می‌خوانیم تا بفهمیم مشکل چه بوده
          const errorText = await postImagesResponse.text();
          console.error("خطا از PostImages:", errorText); // برای دیباگ در داشبورد Cloudflare
          return new Response(JSON.stringify({ error: `PostImages با خطا پاسخ داد: ${postImagesResponse.status}` }), {
            status: 502, // Bad Gateway
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          });
        }
        
        // ۲. حالا که مطمئنیم پاسخ موفقیت‌آمیز است، آن را به عنوان JSON پردازش می‌کنیم
        const result = await postImagesResponse.json();
        
        // ۳. لینک را از پاسخ استخراج می‌کنیم
        const link = result?.url || result?.url_short;

        if (!link) {
           return new Response(JSON.stringify({ error: "لینکی در پاسخ PostImages یافت نشد" }), {
            status: 500,
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          });
        }

        // ۴. پاسخ موفقیت‌آمیز را به همراه لینک به مرورگر کاربر ارسال می‌کنیم
        return new Response(JSON.stringify({ url: link }), {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });

      } catch (e) {
        console.error("خطای داخلی در Worker:", e);
        return new Response(JSON.stringify({ error: "یک خطای پیش‌بینی نشده در سرور رخ داد." }), {
          status: 500,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
    }

    // پاسخ برای متدهای دیگر مثل GET
    return new Response("این Worker فقط درخواست‌های POST برای آپلود تصویر را می‌پذیرد.", {
      headers: corsHeaders,
    });
  }
};
