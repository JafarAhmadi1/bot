<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>آپلود عکس با Cloudflare Images</title>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: right; padding: 2em; }
    #output { margin-top: 1em; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>

  <h2>آپلود عکس با Cloudflare Images و Worker</h2>

  <form id="uploadForm">
    <input type="file" id="fileInput" accept="image/*" required>
    <br><br>
    <button type="submit">آپلود کن</button>
  </form>

  <div id="output"></div>

  <script>
    document.getElementById("uploadForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const outputDiv = document.getElementById("output");
      const fileInput = document.getElementById("fileInput");

      if (fileInput.files.length === 0) {
        outputDiv.innerHTML = `<p class="error">لطفاً یک تصویر انتخاب کنید.</p>`;
        return;
      }
      
      outputDiv.innerHTML = "در حال دریافت لینک آپلود...";

      try {
        // ۱. ابتدا از ورکر خودمان یک لینک یکبار مصرف برای آپلود می‌گیریم
        const workerResponse = await fetch("https://eite2bale.jafar-ahmadi658.workers.dev/");
        const workerResult = await workerResponse.json();

        if (!workerResponse.ok || !workerResult.uploadURL) {
          const errorMessage = workerResult.errors?.[0]?.message || "پاسخ ورکر نامعتبر است.";
          throw new Error(`دریافت لینک آپلود از ورکر با خطا مواجه شد: ${errorMessage}`);
        }

        const uploadURL = workerResult.uploadURL;
        outputDiv.innerHTML = "در حال آپلود تصویر...";

        // ۲. حالا فایل را مستقیماً به لینک دریافتی از Cloudflare Images ارسال می‌کنیم
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        const uploadResponse = await fetch(uploadURL, {
          method: "POST",
          body: formData
        });

        const result = await uploadResponse.json();

        if (result.success) {
          // لینک عمومی تصویر از آرایه variants گرفته می‌شود
          const publicLink = result.result.variants[0]; 
          outputDiv.innerHTML = `<p class="success">✅ لینک تصویر: <a href="${publicLink}" target="_blank">${publicLink}</a></p>`;
        } else {
          // --- این بخش مهم و جدید است ---
          // اگر آپلود ناموفق بود، پیام خطای دقیق را از خود کلادفلر نمایش بده
          const cloudflareError = result.errors[0]?.message || "خطای ناشناخته از سرور آپلود.";
          throw new Error(`آپلود تصویر با خطا مواجه شد: ${cloudflareError}`);
        }

      } catch (error) {
        console.error("خطای کامل:", error);
        outputDiv.innerHTML = `<p class="error">❌ ${error.message}</p>`;
      }
    });
  </script>

</body>
</html>
