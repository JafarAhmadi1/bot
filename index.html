<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§ (ØªØ±Ú©ÛŒØ¨ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
      background-color: #f5f5f5;
    }
    h2 { color: #1a73e8; }
    input[type="file"], select {
      padding: 10px 14px;
      font-size: 16px;
      margin: 12px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 80%;
      max-width: 400px;
    }
    .btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 15px 5px;
      text-decoration: none;
      display: inline-block;
    }
    .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    #output {
      margin-top: 25px;
    }
    #preview-img, #final-image-preview {
      margin-top: 10px;
      max-width: 250px;
      border-radius: 8px;
      border: 2px solid #ccc;
      display: none;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      display: none; /* Ù…Ø®ÙÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <h2>ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h2>
  <p>Ø§Ø¨ØªØ¯Ø§ ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ Ø³Ù¾Ø³ Ù‚Ø§Ø¨ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø¨Ø±Ú¯Ø²ÛŒÙ†ÛŒØ¯:</p>

  <input type="file" id="image-upload" accept="image/*"><br>
  <img id="preview-img" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø´Ù…Ø§"><br>

  <select id="frame-select">
    <option value="frame1">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û±</option>
    <option value="frame2">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û²</option>
    <option value="frame3">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û³</option>
  </select><br>

  <button class="btn" id="generate-btn" onclick="generateFinalImage()" disabled>Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</button>

  <div id="output">
      <div class="loader" id="loader"></div>
      <img id="final-image-preview" alt="ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§">
      <div id="download-container"></div>
  </div>

  <script>
    const FRAME_IMAGE_URLS = {
      // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Cross-OriginØŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª ØªØµØ§ÙˆÛŒØ± Ø§Ø² ÛŒÚ© Ø¯Ø§Ù…Ù†Ù‡ Ù…Ø¹ØªØ¨Ø± Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯
      frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
      frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
      frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
    };

    let userImageFile = null;
    const uploadInput = document.getElementById('image-upload');
    const generateBtn = document.getElementById('generate-btn');

    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
    uploadInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        userImageFile = null;
        generateBtn.disabled = true;
        return;
      }
      userImageFile = file;

      const preview = document.getElementById('preview-img');
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'inline-block';
      generateBtn.disabled = false; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡
    });

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ ØªØµØ§ÙˆÛŒØ±
    async function generateFinalImage() {
      if (!userImageFile) {
        alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªØµÙˆÛŒØ±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯.");
        return;
      }
      
      const loader = document.getElementById('loader');
      const outputDiv = document.getElementById('output');
      const finalImagePreview = document.getElementById('final-image-preview');
      const downloadContainer = document.getElementById('download-container');

      // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯Ø± Ùˆ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ÛŒ Ù‚Ø¨Ù„ÛŒ
      loader.style.display = 'block';
      generateBtn.disabled = true;
      finalImagePreview.style.display = 'none';
      downloadContainer.innerHTML = '';


      // Û±. Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø± Ùˆ ØªØµÙˆÛŒØ± Ù‚Ø§Ø¨
      const frameKey = document.getElementById("frame-select").value;
      const frameUrl = FRAME_IMAGE_URLS[frameKey];

      try {
        const [userImage, frameImage] = await Promise.all([
          loadImage(URL.createObjectURL(userImageFile)),
          loadImage(frameUrl)
        ]);
        
        // Û². Ø³Ø§Ø®Øª ÛŒÚ© Ø¨ÙˆÙ… (Canvas) Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 512; // Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ (Ù…Ø±Ø¨Ø¹)
        canvas.width = size;
        canvas.height = size;
        
        // Û³. Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…Ø±Ú©Ø² Ø¨ÙˆÙ…
        // Ø§ÛŒÙ† Ú©Ø¯ ØªØµÙˆÛŒØ± Ø±Ø§ Ø·ÙˆØ±ÛŒ Ø±Ø³Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ú©Ù„ Ø¨ÙˆÙ… Ø±Ø§ Ø¨Ù¾ÙˆØ´Ø§Ù†Ø¯ Ùˆ Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø´ Ø¨Ø®ÙˆØ±Ø¯ (Ù…Ø«Ù„ fit=crop)
        const userAspectRatio = userImage.width / userImage.height;
        let sx, sy, sWidth, sHeight;
        if (userAspectRatio > 1) { // ØªØµÙˆÛŒØ± Ø¹Ø±ÛŒØ¶â€ŒØªØ± Ø§Ø³Øª
            sHeight = userImage.height;
            sWidth = sHeight;
            sx = (userImage.width - sWidth) / 2;
            sy = 0;
        } else { // ØªØµÙˆÛŒØ± Ø¨Ù„Ù†Ø¯ØªØ± Ø§Ø³Øª
            sWidth = userImage.width;
            sHeight = sWidth;
            sy = (userImage.height - sHeight) / 2;
            sx = 0;
        }
        ctx.drawImage(userImage, sx, sy, sWidth, sHeight, 0, 0, size, size);

        // Û´. Ø±Ø³Ù… Ù‚Ø§Ø¨ Ø±ÙˆÛŒ ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø±
        ctx.drawImage(frameImage, 0, 0, size, size);
        
        // Ûµ. ØªØ¨Ø¯ÛŒÙ„ Ø¨ÙˆÙ… Ø¨Ù‡ ÛŒÚ© ØªØµÙˆÛŒØ± Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯
        const finalImageDataUrl = canvas.toDataURL('image/png');
        
        // Û¶. Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        finalImagePreview.src = finalImageDataUrl;
        finalImagePreview.style.display = 'block';
        
        downloadContainer.innerHTML = `
          <p>âœ… ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!</p>
          <a href="${finalImageDataUrl}" download="parcham-bala.png" class="btn">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</a>
        `;

      } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±:", error);
        alert("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§ Ø§Ø² Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
      } finally {
        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯Ø± Ùˆ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª
        loader.style.display = 'none';
        generateBtn.disabled = false;
      }
    }
    
    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØµÙˆÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¢Ø³Ù†Ú©Ø±ÙˆÙ†
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        // Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ CORS Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² canvas
        img.crossOrigin = "Anonymous"; 
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±: ${src}`);
        img.src = src;
      });
    }

  </script>

</body>
</html>
