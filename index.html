<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Ù…Ù‚Ø§Ø¯ÛŒØ± Ø«Ø§Ø¨Øª ---
    const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/";
    const FRAME_IMAGE_URLS = {
        frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
        frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
        frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png",
        frame4: "https://i.postimg.cc/HnzshzbR/Parcham-Bala-M3.png"
    };

    // --- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ---
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('upload-label');
    const frameSelectionDiv = document.getElementById('frame-selection');
    const outputDiv = document.getElementById('output');
    const canvas = document.getElementById('imageCanvas');
    const restartButton = document.getElementById('restart-button');
    const finalLinkContainer = document.getElementById('final-link');
    const selectionArea = document.getElementById('selection-area');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
    
    // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª ---
    let userFile = null;
    let finalImageBlob = null;
    let EitaaApp, isEitaaEnv = false;

    // --- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
    try {
        EitaaApp = window.Eitaa.WebApp;
        EitaaApp.ready();
        isEitaaEnv = true; // Ø§ÛŒÙ† Ù…ØªØºÛŒØ± Ú©Ù„ÛŒØ¯ Ø­Ù„ Ù…Ø´Ú©Ù„ Ø§Ø³Øª
        EitaaApp.MainButton.hide();
    } catch (e) { 
        console.log("Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯.");
        isEitaaEnv = false;
    }

    // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---
    fileInput.addEventListener('change', handleFileSelect);
    restartButton.addEventListener('click', resetApp);
    confirmUploadBtn.addEventListener('click', handleConfirmUpload);
    cancelPreviewBtn.addEventListener('click', cancelPreview);

    function handleFileSelect(event) {
        if (event.target.files.length === 0) return;
        userFile = event.target.files[0];
        uploadLabel.style.display = 'none';
        outputDiv.innerHTML = `<p>Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>`;
        showFrameSelection();
    }

    function showFrameSelection() {
        frameSelectionDiv.innerHTML = '<p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>';
        Object.keys(FRAME_IMAGE_URLS).forEach((key, index) => {
            const button = document.createElement('button');
            button.innerText = `ğŸ–¼ï¸ Ù‚Ø§Ø¨ ${index + 1}`;
            button.className = 'action-button';
            button.onclick = () => generatePreview(FRAME_IMAGE_URLS[key]);
            frameSelectionDiv.appendChild(button);
        });
        frameSelectionDiv.style.display = 'block';
    }

    async function generatePreview(frameUrl) {
        selectionArea.style.display = 'none';
        outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´...";
        try {
            finalImageBlob = await createFramedImage(userFile, frameUrl);
            const previewUrl = URL.createObjectURL(finalImageBlob);
            previewImage.src = previewUrl;
            
            outputDiv.style.display = 'none';
            previewContainer.style.display = 'block';
        } catch (error) {
            outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
            restartButton.style.display = 'block';
        }
    }
    
    function cancelPreview() {
        previewContainer.style.display = 'none';
        selectionArea.style.display = 'block';
        outputDiv.style.display = 'block';
        outputDiv.innerHTML = '<p>ÛŒÚ© Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
        if(previewImage.src) URL.revokeObjectURL(previewImage.src);
        finalImageBlob = null;
    }

    // --- Ø´Ø±ÙˆØ¹ ØªØºÛŒÛŒØ±Ø§Øª Ø§ØµÙ„ÛŒ ---

    // 1. ØªØ§Ø¨Ø¹ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ØªØµÙ…ÛŒÙ… Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ú©Ø¯Ø§Ù… Ø±ÙˆØ´ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
    function handleConfirmUpload() {
        previewContainer.style.display = 'none';
        outputDiv.style.display = 'block';

        if (!finalImageBlob) {
            outputDiv.innerHTML = `<p class="error">Ø®Ø·Ø§: ØªØµÙˆÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>`;
            restartButton.style.display = 'block';
            return;
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§ÛŒÛŒ
        if (isEitaaEnv) {
            // Ø§Ú¯Ø± Ø¯Ø§Ø®Ù„ Ø§ÛŒØªØ§ Ù‡Ø³ØªÛŒÙ…ØŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙˆØ±Ú©Ø± Ùˆ Ø¨Ù„Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†
            uploadBlobToBaleViaWorker(finalImageBlob);
        } else {
            // Ø§Ú¯Ø± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ù‡Ø³ØªÛŒÙ…ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù† (Ø§Ù…Ù†)
            downloadBlobDirectly(finalImageBlob);
        }
    }

    // 2. ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ùˆ Ø§Ù…Ù† Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±
    function downloadBlobDirectly(blob) {
        try {
            outputDiv.innerHTML = `<p class="success">âœ… ÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³Øª.</p>`;
            const timestamp = Date.now();
            const fileName = `Parcham-Bala-${timestamp}.jpg`;
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù„ÛŒÙ†Ú© Ù…ÙˆÙ‚Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName; // Ø§ÛŒÙ† Ø®Ø· Ø¨Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†Ø¯
            document.body.appendChild(a);
            
            a.click(); // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯
            
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
            URL.revokeObjectURL(url);
            document.body.removeChild(a);

            finalLinkContainer.innerHTML = `<p>Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢ØºØ§Ø² Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.</p>`;
            restartButton.style.display = 'inline-block';

        } catch (error) {
            outputDiv.innerHTML = `<p class="error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯: ${error.message}</p>`;
            restartButton.style.display = 'block';
        }
    }

    // 3. ØªØ§Ø¨Ø¹ Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ø¨Ù„Ù‡ (Ú©Ù‡ ÙÙ‚Ø· Ø¯Ø± Ù…Ø­ÛŒØ· Ø§ÛŒØªØ§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    async function uploadBlobToBaleViaWorker(imageBlob) {
        outputDiv.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±...";
        try {
            const uniqueWorkerUrl = `${workerUrl}?v=${Date.now()}`;
            const formData = new FormData();
            formData.append("file", imageBlob, `Parcham-Bala-${Date.now()}.jpg`);

            const response = await fetch(uniqueWorkerUrl, { method: "POST", body: formData });
            const result = await response.json();

            if (!response.ok || result.error) {
                throw new Error(result.details || result.error || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
            }

            outputDiv.innerHTML = `<p class="success">âœ… ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.</p>`;
            const downloadUrl = result.url;
            
            // Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø±Ø§ Ù‡Ù… Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            finalLinkContainer.innerHTML = `<a href="${downloadUrl}" target="_blank" class="action-button">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</a>`;
            
            // ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ Ø§ÛŒØªØ§
            const uniqueDownloadUrlForEitaa = `${downloadUrl}?v=${Date.now()}`;
            EitaaApp.MainButton.setText("Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±");
            EitaaApp.MainButton.onClick(() => EitaaApp.openLink(uniqueDownloadUrlForEitaa));
            EitaaApp.MainButton.show();

            restartButton.style.display = 'inline-block';

        } catch (error) {
            outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
            restartButton.style.display = 'block';
        }
    }
    
    // --- Ù¾Ø§ÛŒØ§Ù† ØªØºÛŒÛŒØ±Ø§Øª Ø§ØµÙ„ÛŒ ---


    async function createFramedImage(userImageFile, frameImageUrl) {
        const ctx = canvas.getContext('2d');
        const loadImage = (src) => new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => resolve(img);
            img.onerror = (err) => reject(new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ù‚Ø§Ø¨."));
            img.src = src;
        });
        const userImageUrl = URL.createObjectURL(userImageFile);
        const [userImg, frameImg] = await Promise.all([loadImage(userImageUrl), loadImage(frameImageUrl)]);
        URL.revokeObjectURL(userImageUrl);
        const size = 512;
        canvas.width = size; canvas.height = size;
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, size, size);
        const imgAspectRatio = userImg.naturalWidth / userImg.naturalHeight;
        let drawWidth = size, drawHeight = size, x = 0, y = 0;
        if (imgAspectRatio > 1) {
            drawHeight = size; drawWidth = drawHeight * imgAspectRatio; x = (size - drawWidth) / 2;
        } else {
            drawWidth = size; drawHeight = drawWidth / imgAspectRatio; y = (size - drawHeight) / 2;
        }
        ctx.drawImage(userImg, x, y, drawWidth, drawHeight);
        ctx.drawImage(frameImg, 0, 0, size, size);
        return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.90)); 
    }

    function resetApp() {
        userFile = null;
        finalImageBlob = null;
        if(previewImage.src) URL.revokeObjectURL(previewImage.src);

        fileInput.value = '';
        selectionArea.style.display = 'block';
        uploadLabel.style.display = 'inline-block';
        frameSelectionDiv.style.display = 'none';
        frameSelectionDiv.innerHTML = '';
        previewContainer.style.display = 'none';
        outputDiv.style.display = 'block';
        outputDiv.innerHTML = '<p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>';
        finalLinkContainer.innerHTML = '';
        restartButton.style.display = 'none';

        if (isEitaaEnv) {
            EitaaApp.MainButton.hide();
        }
    }
});
</script>
