<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</title>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ÙˆØ¨â€ŒØ§Ù¾ Ø§ÛŒØªØ§ -->
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f0f2f5; 
            color: #1c1e21; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
        }
        .container { 
            max-width: 600px; 
            margin: 2em auto; 
            background-color: #fff; 
            padding: 2em; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1 { 
            font-size: 24px; 
            margin-bottom: 10px; 
            color: #0077cc; 
        }
        p { 
            font-size: 16px; 
            color: #606770; 
            line-height: 1.6;
        }
        
        .action-button { 
            display: inline-block; 
            padding: 12px 25px; 
            margin: 5px; 
            border: none; 
            border-radius: 8px; 
            background-color: #0077cc; 
            color: #ffffff; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background-color 0.2s, opacity 0.2s; 
            text-decoration: none; 
        }
        .action-button:hover:not(:disabled) { 
            background-color: #005fa3; 
        }
        /* Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø±Ø§ Ø³Ø¨Ø² Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨Ø±Ø¬Ø³ØªÙ‡â€ŒØªØ± Ø¨Ø§Ø´Ø¯ */
        #download-btn {
            background-color: #28a745;
        }
        #download-btn:hover {
            background-color: #218838;
        }
        .secondary-button { 
            background-color: #6c757d; 
        }
        .secondary-button:hover:not(:disabled) { 
            background-color: #5a6268; 
        }

        input[type="file"] { 
            display: none; 
        }
        
        #frame-selection { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid #eee; 
        }

        #output { 
            margin-top: 1.5em; 
            padding: 1em; 
            background-color: #f7f7f7; 
            border-radius: 8px; 
            word-wrap: break-word; 
            min-height: 50px; 
        }
        .error { color: #d32f2f; font-weight: bold; }
        
        #preview-container img { 
            max-width: 80%; 
            height: auto; 
            border-radius: 8px; 
            border: 2px solid #ddd; 
            margin-bottom: 1em; 
        }

        canvas { 
            display: none; /* Ú©Ø§Ù†ÙˆØ§Ø³ Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h1>
        
        <!-- Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ùˆ Ù‚Ø§Ø¨ -->
        <div id="selection-area">
            <p>Ø³Ù„Ø§Ù… Ø¨Ù‡ Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø­Ù…Ø§ÛŒØª Ø§Ø² <strong>Ø§ÛŒØ±Ø§Ù† Ø¹Ø²ÛŒØ²</strong> Ùˆ ØªØ²Ø¦ÛŒÙ† ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø¨Ø§ Ù¾Ø±Ú†Ù… Ø³Ù‡ Ø±Ù†Ú¯ Ú©Ø´ÙˆØ±Ù…Ø§Ù†ØŒ Ù„Ø·ÙØ§ ØªØµÙˆÛŒØ± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>

            <div>
                <label for="fileInput" class="action-button" id="upload-label">Û±. Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±</label>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div id="frame-selection" style="display: none;">
                <p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>
            </div>
        </div>
        
        <!-- Ú©Ø§Ù†ÙˆØ§Ø³ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± -->
        <canvas id="imageCanvas"></canvas>

        <!-- Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ -->
        <div id="preview-container" style="display: none;">
            <h3>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</h3>
            <img id="preview-image" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù‚Ø§Ø¨">
            <p>Ø¹Ø§Ù„ÛŒ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.</p>
            <div id="preview-actions">
                <a id="download-btn" class="action-button" download="parcham-bala-profile.jpg">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± (JPG)</a>
                <button id="cancel-preview-btn" class="action-button secondary-button">ğŸ”„ Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø±</button>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª -->
        <div id="output">
            <p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>
        </div>

        <button id="restart-button" class="action-button secondary-button" style="display: none; margin-top: 15px;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Ù…Ù‚Ø§Ø¯ÛŒØ± Ø«Ø§Ø¨Øª ---
        const FRAME_IMAGE_URLS = {
            frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
            frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
            frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
        };
        const FINAL_FILENAME = "parcham-bala-profile.jpg";

        // --- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ---
        const fileInput = document.getElementById('fileInput');
        const uploadLabel = document.getElementById('upload-label');
        const frameSelectionDiv = document.getElementById('frame-selection');
        const outputDiv = document.getElementById('output');
        const canvas = document.getElementById('imageCanvas');
        const restartButton = document.getElementById('restart-button');
        const selectionArea = document.getElementById('selection-area');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const downloadBtn = document.getElementById('download-btn');
        const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
        
        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª ---
        let userFile = null;
        let currentPreviewUrl = null; // Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡
        let EitaaApp, isEitaaEnv = false;

        // --- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        try {
            EitaaApp = window.Eitaa.WebApp;
            EitaaApp.ready();
            isEitaaEnv = true;
            EitaaApp.MainButton.hide();
        } catch (e) { 
            console.log("Ø¯Ø± Ù…Ø­ÛŒØ· Ø®Ø§Ø±Ø¬ Ø§Ø² Ø§ÛŒØªØ§ Ø§Ø¬Ø±Ø§ Ø´Ø¯."); 
        }

        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---
        fileInput.addEventListener('change', handleFileSelect);
        restartButton.addEventListener('click', resetApp);
        cancelPreviewBtn.addEventListener('click', cancelPreview);
        // Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒÚ© ØªÚ¯ <a> Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ event listener Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†Ø¯Ø§Ø±Ø¯

        function handleFileSelect(event) {
            if (event.target.files.length === 0) return;
            userFile = event.target.files[0];
            uploadLabel.style.display = 'none';
            outputDiv.innerHTML = `<p>Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>`;
            showFrameSelection();
        }

        function showFrameSelection() {
            frameSelectionDiv.innerHTML = '<p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>';
            Object.keys(FRAME_IMAGE_URLS).forEach((key, index) => {
                const button = document.createElement('button');
                button.innerText = `ğŸ–¼ï¸ Ù‚Ø§Ø¨ ${index + 1}`;
                button.className = 'action-button';
                button.onclick = () => generatePreview(FRAME_IMAGE_URLS[key]);
                frameSelectionDiv.appendChild(button);
            });
            frameSelectionDiv.style.display = 'block';
        }

        async function generatePreview(frameUrl) {
            selectionArea.style.display = 'none';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´...";

            try {
                const finalImageBlob = await createFramedImage(userFile, frameUrl);
                
                // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡ URL Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                if (currentPreviewUrl) {
                    URL.revokeObjectURL(currentPreviewUrl);
                }

                currentPreviewUrl = URL.createObjectURL(finalImageBlob);

                previewImage.src = currentPreviewUrl;
                downloadBtn.href = currentPreviewUrl;
                downloadBtn.download = FINAL_FILENAME; // Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                
                outputDiv.style.display = 'none';
                previewContainer.style.display = 'block';
                restartButton.style.display = 'none';

                // Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÛŒØªØ§
                if (isEitaaEnv) {
                     EitaaApp.MainButton.setText("Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ±");
                     EitaaApp.MainButton.onClick(() => {
                        EitaaApp.showAlert("Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø³Ø¨Ø² Ø±Ù†Ú¯ 'ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±' Ø¯Ø± ØµÙØ­Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
                     });
                     EitaaApp.MainButton.show();
                }

            } catch (error) {
                outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
                restartButton.style.display = 'block';
            }
        }
        
        function cancelPreview() {
            previewContainer.style.display = 'none';
            selectionArea.style.display = 'block';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<p>ÛŒÚ© Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
            
            // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‚Ø¨Ù„ÛŒ
            if(currentPreviewUrl) {
                URL.revokeObjectURL(currentPreviewUrl);
                currentPreviewUrl = null;
            }
            downloadBtn.href = "#"; // Ù„ÛŒÙ†Ú© Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ú©Ù†ÛŒØ¯

            if(isEitaaEnv) EitaaApp.MainButton.hide();
        }

        async function createFramedImage(userImageFile, frameImageUrl) {
            const ctx = canvas.getContext('2d');
            const loadImage = (src) => new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ CORS Ø¨Ø§ ØªØµØ§ÙˆÛŒØ± Ø§Ø² Ù‡Ø§Ø³Øª Ø¯ÛŒÚ¯Ø±
                img.onload = () => resolve(img);
                img.onerror = (err) => reject(new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±. Ù„Ø·ÙØ§ Ø§Ø² Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯."));
                img.src = src;
            });

            const userImageUrl = URL.createObjectURL(userImageFile);
            
            const [userImg, frameImg] = await Promise.all([
                loadImage(userImageUrl), 
                loadImage(frameImageUrl)
            ]);

            URL.revokeObjectURL(userImageUrl); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡
            
            const size = 512;
            canvas.width = size; 
            canvas.height = size;

            // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ø³ÙÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø³ÛŒØ§Ù‡ÛŒ Ø¯Ø± ØªØµØ§ÙˆÛŒØ± PNG Ø´ÙØ§Ù
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, size, size);

            const imgAspectRatio = userImg.naturalWidth / userImg.naturalHeight;
            let drawWidth = size, drawHeight = size, x = 0, y = 0;
            
            // ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Fill Ø¯Ø± Ù…Ø±Ú©Ø² Ú©Ø§Ù†ÙˆØ§Ø³ Ø±Ø³Ù… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (imgAspectRatio > 1) { // ØªØµÙˆÛŒØ± Ø¹Ø±ÛŒØ¶ (Landscape)
                drawHeight = size; 
                drawWidth = drawHeight * imgAspectRatio; 
                x = (size - drawWidth) / 2;
            } else { // ØªØµÙˆÛŒØ± Ø¨Ù„Ù†Ø¯ ÛŒØ§ Ù…Ø±Ø¨Ø¹ (Portrait or Square)
                drawWidth = size; 
                drawHeight = drawWidth / imgAspectRatio; 
                y = (size - drawHeight) / 2;
            }
            ctx.drawImage(userImg, x, y, drawWidth, drawHeight);
            ctx.drawImage(frameImg, 0, 0, size, size);
            
            // Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø§ ÙØ±Ù…Øª JPEG Ùˆ Ú©ÛŒÙÛŒØª 90% Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.90)); 
        }

        function resetApp() {
            userFile = null;
            if(currentPreviewUrl) {
                URL.revokeObjectURL(currentPreviewUrl);
                currentPreviewUrl = null;
            }

            fileInput.value = '';
            selectionArea.style.display = 'block';
            uploadLabel.style.display = 'inline-block';
            frameSelectionDiv.style.display = 'none';
            frameSelectionDiv.innerHTML = '';
            previewContainer.style.display = 'none';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>';
            downloadBtn.href = '#';
            restartButton.style.display = 'none';

            if (isEitaaEnv) {
                EitaaApp.MainButton.hide();
            }
        }
    });
    </script>
</body>
</html>
