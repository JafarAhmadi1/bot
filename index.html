<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پویش پرچم بالا</title>
    
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 2em auto; background-color: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 0; color: #0077cc; }
        p { font-size: 16px; color: #606770; }
        
        .action-button { display: inline-block; padding: 12px 25px; margin: 5px; border: none; border-radius: 8px; background-color: #0077cc; color: #ffffff; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #005fa3; }
        .action-button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .secondary-button { background-color: #6c757d; }
        .secondary-button:hover:not(:disabled) { background-color: #5a6268; }

        input[type="file"] { display: none; }
        #frame-selection { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        #output { margin-top: 1.5em; padding: 1em; background-color: #f7f7f7; border-radius: 8px; word-wrap: break-word; min-height: 50px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        #preview-container img { max-width: 80%; height: auto; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 1em; }
        canvas { display: none; }
    </style>
</head>
<body>
    
    <div class="container">
        <h1 style="margin-bottom: 5px;">🇮🇷 پویش پرچم بالا</h1>
        <p id="visitor-counter-container" style="display: none; margin-top: 0; font-size: 12px; color: #888;">
            تعداد تصاویر ساخته شده: <span id="visitor-count">...</span>
        </p>
        
        <div id="initial-choice-container" style="display: none;">
            <p style="font-size: 16px; background-color: #e7f3fe; color: #0c5460; padding: 15px; border-radius: 8px; border: 1px solid #bde5f8;">
                💡 **پیشنهاد ویژه:**<br>
                برای سرعت و کیفیت بهتر، آیا مایلید به نسخه سریع وب منتقل شوید؟
            </p>
            <div>
                <a href="https://YOUR_GITHUB_USERNAME.github.io/YOUR_REPO_NAME/" target="_blank" class="action-button">
                    ✅ بله، من را به نسخه وب ببر
                </a>
                <button id="continue-no-btn" class="action-button secondary-button">
                     خیر، در همینجا ادامه می‌دهم
                </button>
            </div>
        </div>

        <div id="main-app-container" style="display: none;">
            <div id="selection-area">
                <p>سلام به پویش پرچم بالا خوش آومدید. برای حمایت از <b>ایران جان</b> و برای تزئین تصویرتون با پرچم سه رنگ ایران عزیز، لطفا تصویر پروفایلتون رو ارسال کنید.</p>
                <div>
                    <label for="fileInput" class="action-button" id="upload-label">۱. انتخاب تصویر</label>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div id="frame-selection" style="display: none;"></div>
            </div>
            
            <canvas id="imageCanvas"></canvas>

            <div id="preview-container" style="display: none;">
                <h3>پیش‌نمایش تصویر نهایی</h3>
                <img id="preview-image" alt="پیش‌نمایش تصویر با قاب">
                <p>آیا از نتیجه راضی هستید؟</p>
                <div>
                    <button id="cancel-preview-btn" class="action-button secondary-button">🔄 انتخاب قاب دیگر</button>
                    <button id="confirm-upload-btn" class="action-button">✅ بله، دانلودش کن</button>
                </div>
            </div>

            <div id="output"><p>منتظر انتخاب شما...</p></div>
            <p id="final-link" style="margin-top: 10px;"></p>
            <button id="restart-button" class="action-button secondary-button" style="display: none;">شروع مجدد</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- مقادیر ثابت ---
    const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/";
    const FRAMES_DATA = [
        { label: "🖼️ قاب ۱", url: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png" },
        { label: "🖼️ قاب ۲", url: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png" },
        { label: "🖼️ قاب ۳", url: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png" },
        { label: "🏴 قاب محرم", url: "https://i.postimg.cc/HnzshzbR/Parcham-Bala-M3.png" }
    ];

    // --- دسترسی به عناصر ---
    const fileInput = document.getElementById('fileInput');
    const outputDiv = document.getElementById('output');
    const canvas = document.getElementById('imageCanvas');
    const restartButton = document.getElementById('restart-button');
    const finalLinkContainer = document.getElementById('final-link');
    const previewContainer = document.getElementById('preview-container');
    const confirmUploadBtn = document.getElementById('confirm-upload-btn');
    const initialChoiceContainer = document.getElementById('initial-choice-container');
    const mainAppContainer = document.getElementById('main-app-container');
    const continueNoBtn = document.getElementById('continue-no-btn');
    const visitorCounterContainer = document.getElementById('visitor-counter-container');
    const visitorCountSpan = document.getElementById('visitor-count');

    // --- متغیر وضعیت ---
    let finalImageBlob = null;
    let isEitaaEnv = false;

    // --- بخش شمارنده بازدید ---
    // این تابع فقط عدد فعلی را میخواند و نمایش میدهد
    async function fetchAndDisplayCount() {
        visitorCounterContainer.style.display = 'block';
        try {
            const response = await fetch(`${workerUrl}count`, { method: 'GET' });
            if (!response.ok) throw new Error('پاسخ شبکه صحیح نبود');
            const count = await response.text();
            visitorCountSpan.textContent = parseInt(count).toLocaleString('fa');
        } catch (error) {
            console.error("خطا در خواندن تعداد بازدید:", error);
            visitorCountSpan.textContent = 'نامشخص';
        }
    }

    // این تابع عدد را افزایش میدهد و عدد جدید را نمایش میدهد
    async function incrementAndDisplayCount() {
        try {
            const response = await fetch(`${workerUrl}count`, { method: 'POST' });
            if (!response.ok) throw new Error('پاسخ شبکه صحیح نبود');
            const newCount = await response.text();
            visitorCountSpan.textContent = parseInt(newCount).toLocaleString('fa');
        } catch (error) {
            console.error("خطا در افزایش تعداد بازدید:", error);
        }
    }

    // --- بخش تشخیص محیط و نمایش اولیه ---
    if (window.Eitaa && window.Eitaa.WebApp && window.Eitaa.WebApp.platform && window.Eitaa.WebApp.platform !== 'unknown') {
        isEitaaEnv = true;
        window.Eitaa.WebApp.ready();
        initialChoiceContainer.style.display = 'block';
    } else {
        isEitaaEnv = false;
        mainAppContainer.style.display = 'block';
        // به محض باز شدن نسخه وب، عدد فعلی را بخوان و نمایش بده
        fetchAndDisplayCount();
    }

    // --- رویدادها ---
    continueNoBtn.addEventListener('click', () => {
        initialChoiceContainer.style.display = 'none';
        mainAppContainer.style.display = 'block';
    });
    fileInput.addEventListener('change', handleFileSelect);
    restartButton.addEventListener('click', resetApp);
    confirmUploadBtn.addEventListener('click', handleConfirmUpload);
    document.getElementById('cancel-preview-btn').addEventListener('click', cancelPreview);

    // --- توابع اصلی برنامه ---
    function handleConfirmUpload() {
        previewContainer.style.display = 'none';
        outputDiv.style.display = 'block';
        if (!finalImageBlob) { outputDiv.innerHTML = `<p class="error">خطا: تصویری یافت نشد.</p>`; return; }
        if (isEitaaEnv) { uploadBlobToBaleViaWorker(finalImageBlob); } else { downloadBlobDirectly(finalImageBlob); }
    }

    function downloadBlobDirectly(blob) {
        try {
            const fileName = `Parcham-Bala-${Date.now()}.jpg`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none'; a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // پس از دانلود موفق، شمارنده را افزایش بده
            incrementAndDisplayCount();

            outputDiv.innerHTML = `<p class="success">✅ دانلود شما آغاز شد.</p>`;
            restartButton.style.display = 'inline-block';
        } catch (error) {
            outputDiv.innerHTML = `<p class="error">❌ خطا در دانلود: ${error.message}</p>`;
        }
    }

    async function uploadBlobToBaleViaWorker(imageBlob) {
        // ... (این تابع بدون تغییر باقی می‌ماند)
        outputDiv.innerHTML = "⏳ در حال ارسال تصویر به سرور...";
        confirmUploadBtn.disabled = true;
        try {
            const formData = new FormData();
            formData.append("file", imageBlob, `Parcham-Bala-${Date.now()}.jpg`);
            const response = await fetch(workerUrl, { method: "POST", body: formData });
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.details || result.error || "خطای سرور.");
            outputDiv.innerHTML = `<p class="success">✅ بارگذاری موفق.</p>`;
            const downloadUrl = result.url;
            finalLinkContainer.innerHTML = `<a href="${downloadUrl}" target="_blank" class="action-button">📥 دانلود تصویر</a>`;
            const EitaaApp = window.Eitaa.WebApp;
            EitaaApp.MainButton.setText("دانلود تصویر").onClick(() => EitaaApp.openLink(downloadUrl)).show();
            restartButton.style.display = 'inline-block';
        } catch (error) {
            outputDiv.innerHTML = `<p class="error">❌ خطا در آپلود: ${error.message}</p>`;
        } finally {
            confirmUploadBtn.disabled = false;
        }
    }

    // --- توابع کمکی (بدون تغییر) ---
    async function handleFileSelect(event) { if (event.target.files.length === 0) return; const userFile = event.target.files[0]; const selectionArea = document.getElementById('selection-area'); document.getElementById('upload-label').style.display = 'none'; outputDiv.innerHTML = `<p>عالی! حالا یک قاب انتخاب کنید.</p>`; showFrameSelection(userFile); }
    function showFrameSelection(userFile) { const frameSelectionDiv = document.getElementById('frame-selection'); frameSelectionDiv.innerHTML = '<p>۲. انتخاب قاب</p>'; FRAMES_DATA.forEach(frame => { const button = document.createElement('button'); button.innerText = frame.label; button.className = 'action-button'; button.onclick = () => generatePreview(userFile, frame.url); frameSelectionDiv.appendChild(button); }); frameSelectionDiv.style.display = 'block'; }
    async function generatePreview(userFile, frameUrl) { const selectionArea = document.getElementById('selection-area'); selectionArea.style.display = 'none'; outputDiv.style.display = 'block'; outputDiv.innerHTML = "⏳ در حال ساخت پیش‌نمایش..."; try { finalImageBlob = await createFramedImage(userFile, frameUrl); const previewUrl = URL.createObjectURL(finalImageBlob); document.getElementById('preview-image').src = previewUrl; outputDiv.style.display = 'none'; previewContainer.style.display = 'block'; } catch (error) { outputDiv.innerHTML = `<p class="error">❌ ${error.message}</p>`; restartButton.style.display = 'block'; } }
    function cancelPreview() { const selectionArea = document.getElementById('selection-area'); previewContainer.style.display = 'none'; selectionArea.style.display = 'block'; outputDiv.style.display = 'block'; outputDiv.innerHTML = '<p>یک قاب دیگر انتخاب کنید.</p>'; URL.revokeObjectURL(document.getElementById('preview-image').src); finalImageBlob = null; }
    async function createFramedImage(userImageFile, frameImageUrl) { const ctx = canvas.getContext('2d'); const loadImage = (src) => new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => resolve(img); img.onerror = () => reject(new Error("خطا در بارگذاری قاب")); img.src = src; }); const userImageUrl = URL.createObjectURL(userImageFile); const [userImg, frameImg] = await Promise.all([loadImage(userImageUrl), loadImage(frameImageUrl)]); URL.revokeObjectURL(userImageUrl); const size = 512; canvas.width = size; canvas.height = size; const userAspect = userImg.width / userImg.height; let sx, sy, sWidth, sHeight; if (userAspect > 1) { sHeight = userImg.height; sWidth = sHeight; sx = (userImg.width - sWidth) / 2; sy = 0; } else { sWidth = userImg.width; sHeight = sWidth; sx = 0; sy = (userImg.height - sHeight) / 2; } ctx.drawImage(userImg, sx, sy, sWidth, sHeight, 0, 0, size, size); ctx.drawImage(frameImg, 0, 0, size, size); return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.90)); }
    function resetApp() { finalImageBlob = null; if (document.getElementById('preview-image').src) { URL.revokeObjectURL(document.getElementById('preview-image').src); } fileInput.value = ''; const selectionArea = document.getElementById('selection-area'); selectionArea.style.display = 'block'; document.getElementById('upload-label').style.display = 'inline-block'; document.getElementById('frame-selection').style.display = 'none'; previewContainer.style.display = 'none'; outputDiv.style.display = 'block'; outputDiv.innerHTML = '<p>منتظر انتخاب شما...</p>'; finalLinkContainer.innerHTML = ''; restartButton.style.display = 'none'; if (isEitaaEnv) { window.Eitaa.WebApp.MainButton.hide(); } }
});
</script>

</body>
</html>
