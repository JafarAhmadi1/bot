<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ Ø¨Ø§ Ù‚Ø§Ø¨ Ø¨Ù‡ ImageKit.io</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 2em auto; background-color: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 10px; color: #0077cc; }
        p { font-size: 16px; color: #606770; }
        
        .action-button { display: inline-block; padding: 12px 25px; margin-top: 15px; border: none; border-radius: 8px; background-color: #0077cc; color: #ffffff; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #005fa3; }
        .action-button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }

        input[type="file"] { display: none; }
        
        #frame-selection { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        #frame-selection button { margin: 5px; }

        #output { margin-top: 1.5em; padding: 1em; background-color: #f7f7f7; border-radius: 8px; word-wrap: break-word; min-height: 50px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        a { color: #0077cc; text-decoration: none; }
        a:hover { text-decoration: underline; }

        canvas { display: none; /* Ú©Ø§Ù†ÙˆØ§Ø³ Ø±Ø§ Ø§Ø² Ø¯ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… */}
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h1>
        <p>Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¹Ú©Ø³ Ø®ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ Ù‚Ø§Ø¨ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>

        <!-- Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± -->
        <div>
            <label for="fileInput" class="action-button" id="upload-label">Û±. Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨ (Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù…Ø®ÙÛŒ) -->
        <div id="frame-selection" style="display: none;">
            <p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>
            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <!-- Ú©Ø§Ù†ÙˆØ§Ø³ Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ ØªØµØ§ÙˆÛŒØ± (Ù…Ø®ÙÛŒ) -->
        <canvas id="imageCanvas"></canvas>

        <!-- Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ù†ØªÛŒØ¬Ù‡ -->
        <div id="output">
            <p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ (Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù…Ø®ÙÛŒ) -->
        <button id="restart-button" class="action-button" style="display: none; background-color: #606770;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>

    </div>

    <script>
    // --- Ù…Ù‚Ø§Ø¯ÛŒØ± Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ---
    const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/";
    const imagekitPublicKey = "public_93KUnZJ92ve8aZ91xGGC7/AXbvo=";

    // --- Ø¢Ø¯Ø±Ø³ Ù‚Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ ---
    const FRAME_IMAGE_URLS = {
        frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
        frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
        frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
    };

    // --- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ØµÙØ­Ù‡ ---
    const fileInput = document.getElementById('fileInput');
    const uploadLabel = document.getElementById('upload-label');
    const frameSelectionDiv = document.getElementById('frame-selection');
    const outputDiv = document.getElementById('output');
    const canvas = document.getElementById('imageCanvas');
    const restartButton = document.getElementById('restart-button');
    
    let userFile = null;

    // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---
    fileInput.addEventListener('change', handleFileSelect);
    restartButton.addEventListener('click', resetApp);

    function handleFileSelect(event) {
        if (event.target.files.length === 0) return;
        userFile = event.target.files[0];
        
        uploadLabel.style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
        outputDiv.innerHTML = `<p>Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>`;
        showFrameSelection();
    }

    function showFrameSelection() {
        frameSelectionDiv.innerHTML = '<p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>'; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ù‚Ø¨Ù„ÛŒ
        Object.keys(FRAME_IMAGE_URLS).forEach((key, index) => {
            const button = document.createElement('button');
            button.innerText = `ğŸ–¼ï¸ Ù‚Ø§Ø¨ ${index + 1}`;
            button.className = 'action-button';
            button.onclick = () => processAndUpload(FRAME_IMAGE_URLS[key]);
            frameSelectionDiv.appendChild(button);
        });
        frameSelectionDiv.style.display = 'block';
    }

    async function processAndUpload(frameUrl) {
        // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„ÛŒÚ© Ù…Ø¬Ø¯Ø¯
        frameSelectionDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØµÙˆÛŒØ± Ø´Ù…Ø§...";

        try {
            // Û±. ØªØ±Ú©ÛŒØ¨ ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‚Ø§Ø¨ Ø±ÙˆÛŒ Ú©Ø§Ù†ÙˆØ§Ø³
            const imageBlob = await createFramedImage(userFile, frameUrl);

            // Û². Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ (Blob) Ø¨Ù‡ ImageKit
            await uploadBlobToImageKit(imageBlob);

        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ú©Ù„ÛŒ:", error);
            outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
            restartButton.style.display = 'block'; // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
        }
    }

    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÛŒÚ© ÙØ§ÛŒÙ„ Ø¹Ú©Ø³ Ùˆ Ø¢Ø¯Ø±Ø³ Ù‚Ø§Ø¨ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ùˆ ÛŒÚ© Blob Ø§Ø² Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
    async function createFramedImage(userImageFile, frameImageUrl) {
        const ctx = canvas.getContext('2d');
        const loadImage = (src) => new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ú©Ø§Ù†ÙˆØ§Ø³
            img.onload = () => resolve(img);
            img.onerror = (err) => reject(new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ù‚Ø§Ø¨. Ø§Ø² Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯."));
            img.src = src;
        });

        const userImageUrl = URL.createObjectURL(userImageFile);

        const [userImg, frameImg] = await Promise.all([
            loadImage(userImageUrl),
            loadImage(frameImageUrl)
        ]);

        URL.revokeObjectURL(userImageUrl); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡

        const size = 512; // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù†Ù‡Ø§ÛŒÛŒ ØªØµÙˆÛŒØ± Ù…Ø±Ø¨Ø¹ÛŒ
        canvas.width = size;
        canvas.height = size;

        // Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù…Ø±Ú©Ø² Ø¨Ø±Ø§ÛŒ Ø¬Ø§ Ø´Ø¯Ù† Ø¯Ø± Ú©Ø§Ø¯Ø± Ù…Ø±Ø¨Ø¹ÛŒ
        const imgAspectRatio = userImg.naturalWidth / userImg.naturalHeight;
        let drawWidth = size, drawHeight = size, x = 0, y = 0;

        if (imgAspectRatio > 1) { // ØªØµÙˆÛŒØ± Ø¹Ø±ÛŒØ¶ Ø§Ø³Øª
            drawHeight = size;
            drawWidth = drawHeight * imgAspectRatio;
            x = (size - drawWidth) / 2;
        } else { // ØªØµÙˆÛŒØ± Ø¨Ù„Ù†Ø¯ Ø§Ø³Øª
            drawWidth = size;
            drawHeight = drawWidth / imgAspectRatio;
            y = (size - drawHeight) / 2;
        }
        
        ctx.drawImage(userImg, x, y, drawWidth, drawHeight);
        ctx.drawImage(frameImg, 0, 0, size, size); // Ú©Ø´ÛŒØ¯Ù† Ù‚Ø§Ø¨ Ø±ÙˆÛŒ ØªØµÙˆÛŒØ±

        // ØªØ¨Ø¯ÛŒÙ„ Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ø§Ù†ÙˆØ§Ø³ Ø¨Ù‡ Blob (ÙØ±Ù…Øª Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯)
        return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    }


    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Blob Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ù‡ ImageKit Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    async function uploadBlobToImageKit(imageBlob) {
        outputDiv.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ...";

        // Û±. Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² ÙˆØ±Ú©Ø±
        const authResponse = await fetch(workerUrl);
        if (!authResponse.ok) throw new Error("Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ ÙˆØ±Ú©Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.");
        const authData = await authResponse.json();
        if (authData.error) throw new Error(`Ø®Ø·Ø§ Ø§Ø² ÙˆØ±Ú©Ø±: ${authData.error}`);
        
        outputDiv.innerHTML = "ØªÙˆÚ©Ù† Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ...";

        // Û². Ø³Ø§Ø®Øª ÙØ±Ù… Ø¯ÛŒØªØ§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ImageKit.io
        const formData = new FormData();
        formData.append("file", imageBlob, "profile-framed.png"); // Ø§Ø±Ø³Ø§Ù„ Blob Ø¨Ø§ ÛŒÚ© Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        formData.append("publicKey", imagekitPublicKey);
        formData.append("signature", authData.signature);
        formData.append("expire", authData.expire);
        formData.append("token", authData.token);
        formData.append("fileName", "profile-framed.png");

        const uploadResponse = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
            method: "POST",
            body: formData
        });
        
        const result = await uploadResponse.json();

        if (uploadResponse.ok) {
            const publicLink = result.url;
            outputDiv.innerHTML = `<p class="success">âœ… ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯!</p><p>Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯:</p><a href="${publicLink}" target="_blank">${publicLink}</a>`;
            frameSelectionDiv.style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨
            restartButton.style.display = 'block'; // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯
        } else {
            throw new Error(`Ø®Ø·Ø§ Ø§Ø² ImageKit.io: ${result.message}`);
        }
    }

    function resetApp() {
        userFile = null;
        fileInput.value = ''; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± ÙØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒ
        uploadLabel.style.display = 'inline-block';
        frameSelectionDiv.style.display = 'none';
        frameSelectionDiv.innerHTML = '';
        outputDiv.innerHTML = '<p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>';
        restartButton.style.display = 'none';
    }

    </script>
</body>
</html>
