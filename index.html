<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</title>
  <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .action-button {
      background-color: #28a745; color: white; padding: 12px 24px;
      border: none; border-radius: 8px; font-size: 16px;
      margin: 10px; cursor: pointer;
    }
    #image-canvas { display: none; }
    #result-image { max-width: 100%; border: 2px solid gray; border-radius: 8px; }
  </style>
</head>
<body>
<h1>ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h1>
<p>Ù„Ø·ÙØ§ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>

<input type="file" id="image-upload" accept="image/*">
<div id="frame-buttons"></div>
<canvas id="image-canvas"></canvas>

<div id="result-area" style="display:none;">
  <h3>âœ… ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§</h3>
  <img id="result-image">
  <br>
  <button id="final-action-button" class="action-button"></button>
  <button onclick="resetApp()" class="action-button">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
</div>

<div id="status" style="margin-top: 15px; font-weight: bold;"></div>

<script>
  const canvas = document.getElementById('image-canvas');
  const ctx = canvas.getContext('2d');
  const resultImg = document.getElementById('result-image');
  const finalButton = document.getElementById('final-action-button');
  const statusDiv = document.getElementById('status');

  const FRAME_IMAGE_URLS = {
    frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
    frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
    frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
  };

  let userImageUrl = null;
  let isEitaa = false;
  let EitaaApp;

  try {
    EitaaApp = window.Eitaa.WebApp;
    EitaaApp.ready();
    isEitaa = true;
  } catch (e) {}

  document.getElementById('image-upload').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    userImageUrl = URL.createObjectURL(file);
    const frameContainer = document.getElementById('frame-buttons');
    frameContainer.innerHTML = "<p>ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>";
    for (const [key, url] of Object.entries(FRAME_IMAGE_URLS)) {
      const btn = document.createElement('button');
      btn.innerText = key;
      btn.className = 'action-button';
      btn.onclick = () => generateImage(userImageUrl, url);
      frameContainer.appendChild(btn);
    }
  });

  async function loadImage(src) {
    return new Promise((res, rej) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => res(img);
      img.onerror = rej;
      img.src = src;
    });
  }

  async function generateImage(userSrc, frameSrc) {
    statusDiv.innerText = "Ø¯Ø±Ø­Ø§Ù„ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ±...";
    const [userImg, frameImg] = await Promise.all([loadImage(userSrc), loadImage(frameSrc)]);

    const size = 256;
    canvas.width = canvas.height = size;

    const aspect = userImg.naturalWidth / userImg.naturalHeight;
    let drawW = size, drawH = size, dx = 0, dy = 0;

    if (aspect > 1) {
      drawH = size;
      drawW = size * aspect;
      dx = (size - drawW) / 2;
    } else {
      drawW = size;
      drawH = size / aspect;
      dy = (size - drawH) / 2;
    }

    ctx.drawImage(userImg, dx, dy, drawW, drawH);
    ctx.drawImage(frameImg, 0, 0, size, size);

    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    resultImg.src = dataUrl;
    document.getElementById('result-area').style.display = 'block';

    if (isEitaa) {
      finalButton.innerText = "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø±Ø¨Ø§Øª";
    } else {
      finalButton.innerText = "ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯";
    }

    finalButton.onclick = () => {
      if (isEitaa) {
        const base64 = dataUrl.split(',')[1];
        try {
          EitaaApp.sendData(base64);
          statusDiv.innerText = "ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!";
        } catch (err) {
          console.error(err);
          statusDiv.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø±Ø¨Ø§Øª";
        }
      } else {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'profile-framed.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    statusDiv.innerText = "";
  }

  function resetApp() {
    document.getElementById('image-upload').value = '';
    document.getElementById('frame-buttons').innerHTML = '';
    document.getElementById('result-area').style.display = 'none';
    statusDiv.innerText = '';
    resultImg.src = '';
    if (userImageUrl) {
      URL.revokeObjectURL(userImageUrl);
      userImageUrl = null;
    }
  }
</script>

</body>
</html>
