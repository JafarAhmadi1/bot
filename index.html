<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</title>
    
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 2em auto; background-color: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 10px; color: #0077cc; }
        p { font-size: 16px; color: #606770; }
        
        .action-button { display: inline-block; padding: 12px 25px; margin: 5px; border: none; border-radius: 8px; background-color: #0077cc; color: #ffffff; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; text-decoration: none; }
        .action-button:hover:not(:disabled) { background-color: #005fa3; }
        .action-button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .secondary-button { background-color: #6c757d; }
        .secondary-button:hover:not(:disabled) { background-color: #5a6268; }

        input[type="file"] { display: none; }
        
        #frame-selection { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }

        #output { margin-top: 1.5em; padding: 1em; background-color: #f7f7f7; border-radius: 8px; word-wrap: break-word; min-height: 50px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        
        #preview-container img { max-width: 80%; height: auto; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 1em; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ‡®ğŸ‡· Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h1>
        
        <!-- Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ùˆ Ù‚Ø§Ø¨ -->
        <div id="selection-area">
            <p>Ø³Ù„Ø§Ù… Ø¨Ù‡ Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§ Ø®ÙˆØ´ Ø¢ÙˆÙ…Ø¯ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø­Ù…Ø§ÛŒØª Ø§Ø² <b>Ø§ÛŒØ±Ø§Ù† Ø¬Ø§Ù†</b>* Ùˆ Ø¨Ø±Ø§ÛŒ ØªØ²Ø¦ÛŒÙ† ØªØµÙˆÛŒØ±ØªÙˆÙ† Ø¨Ø§ Ù¾Ø±Ú†Ù… Ø³Ù‡ Ø±Ù†Ú¯ Ø§ÛŒØ±Ø§Ù† Ø¹Ø²ÛŒØ²ØŒ Ù„Ø·ÙØ§ ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØªÙˆÙ† Ø±Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>

            <div>
                <label for="fileInput" class="action-button" id="upload-label">Û±. Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±</label>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div id="frame-selection" style="display: none;">
                <p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>
            </div>
        </div>
        
        <canvas id="imageCanvas"></canvas>

        <!-- Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ùˆ ØªØ§ÛŒÛŒØ¯ -->
        <div id="preview-container" style="display: none;">
            <h3>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</h3>
            <img id="preview-image" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù‚Ø§Ø¨">
            <p>Ø¢ÛŒØ§ Ø§Ø² Ù†ØªÛŒØ¬Ù‡ Ø±Ø§Ø¶ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ</p>
            <div id="preview-actions">
                <button id="cancel-preview-btn" class="action-button secondary-button">ğŸ”„ Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø±</button>
                <button id="confirm-upload-btn" class="action-button">âœ… Ø¨Ù„Ù‡ØŒ Ù…ÛŒØ®ÙˆØ§Ù… Ø¯Ø§Ù†Ù„ÙˆØ¯Ø´ Ú©Ù†Ù… </button>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ù„ÛŒÙ†Ú© Ù†Ù‡Ø§ÛŒÛŒ -->
        <div id="output">
            <p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>
        </div>
<!--         <div id="final-link"></div> -->
        <p id="final-link" style="margin-top: 10px; word-break: break-all; font-size: 13px; color: #555;"></p>

        <button id="restart-button" class="action-button secondary-button" style="display: none;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Ù…Ù‚Ø§Ø¯ÛŒØ± Ø«Ø§Ø¨Øª ---
        const workerUrl = "https://eite2bale.jafar-ahmadi658.workers.dev/";
        const imagekitPublicKey = "public_93KUnZJ92ve8aZ91xGGC7/AXbvo=";
        const FRAME_IMAGE_URLS = {
            frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
            frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
            frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
        };

        // --- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ---
        const fileInput = document.getElementById('fileInput');
        const uploadLabel = document.getElementById('upload-label');
        const frameSelectionDiv = document.getElementById('frame-selection');
        const outputDiv = document.getElementById('output');
        const canvas = document.getElementById('imageCanvas');
        const restartButton = document.getElementById('restart-button');
        const finalLinkContainer = document.getElementById('final-link');
        const selectionArea = document.getElementById('selection-area');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const confirmUploadBtn = document.getElementById('confirm-upload-btn');
        const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
        
        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª ---
        let userFile = null;
        let finalImageBlob = null; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù¾Ù„ÙˆØ¯
        let EitaaApp, isEitaaEnv = false;

        // --- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        try {
            EitaaApp = window.Eitaa.WebApp;
            EitaaApp.ready();
            isEitaaEnv = true;
            EitaaApp.MainButton.hide();
        } catch (e) { console.log("Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø§Ø¬Ø±Ø§ Ø´Ø¯."); }

        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---
        fileInput.addEventListener('change', handleFileSelect);
        restartButton.addEventListener('click', resetApp);
        confirmUploadBtn.addEventListener('click', handleConfirmUpload);
        cancelPreviewBtn.addEventListener('click', cancelPreview);

        function handleFileSelect(event) {
            if (event.target.files.length === 0) return;
            userFile = event.target.files[0];
            uploadLabel.style.display = 'none';
            outputDiv.innerHTML = `<p>Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÛŒÚ© Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>`;
            showFrameSelection();
        }

        function showFrameSelection() {
            frameSelectionDiv.innerHTML = '<p>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ø¨</p>';
            Object.keys(FRAME_IMAGE_URLS).forEach((key, index) => {
                const button = document.createElement('button');
                button.innerText = `ğŸ–¼ï¸ Ù‚Ø§Ø¨ ${index + 1}`;
                button.className = 'action-button';
                button.onclick = () => generatePreview(FRAME_IMAGE_URLS[key]);
                frameSelectionDiv.appendChild(button);
            });
            frameSelectionDiv.style.display = 'block';
        }

        async function generatePreview(frameUrl) {
            selectionArea.style.display = 'none';
            outputDiv.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´...";

            try {
                finalImageBlob = await createFramedImage(userFile, frameUrl);
                const previewUrl = URL.createObjectURL(finalImageBlob);
                previewImage.src = previewUrl;
                
                outputDiv.style.display = 'none';
                previewContainer.style.display = 'block';
            } catch (error) {
                outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
                restartButton.style.display = 'block';
            }
        }
        
        function cancelPreview() {
            previewContainer.style.display = 'none';
            selectionArea.style.display = 'block';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<p>ÛŒÚ© Ù‚Ø§Ø¨ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
            // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù‚Ø¨Ù„ÛŒ
            if(previewImage.src) URL.revokeObjectURL(previewImage.src);
            finalImageBlob = null;
        }

        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù‡ Ùˆ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø§Ø®Ù„ Ø¢Ù† Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯
function handleConfirmUpload() {
    previewContainer.style.display = 'none';
    outputDiv.style.display = 'block';
    if (finalImageBlob) {
        // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¬Ø§ÛŒ ØªØ§Ø¨Ø¹ Ù‚Ø¯ÛŒÙ…ÛŒ
        uploadBlobToBaleViaWorker(finalImageBlob);
    } else {
        outputDiv.innerHTML = `<p class="error">Ø®Ø·Ø§: ØªØµÙˆÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>`;
        restartButton.style.display = 'block';
    }
}

// Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø¯Ø± Ú©Ø¯ HTML Ø®ÙˆØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯

async function createFramedImage(userImageFile, frameImageUrl) {
    const ctx = canvas.getContext('2d');
    const loadImage = (src) => new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ù‚Ø§Ø¨."));
        img.src = src;
    });
    const userImageUrl = URL.createObjectURL(userImageFile);
    const [userImg, frameImg] = await Promise.all([loadImage(userImageUrl), loadImage(frameImageUrl)]);
    URL.revokeObjectURL(userImageUrl);
    const size = 512;
    canvas.width = size; canvas.height = size;

    // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø³ÛŒØ§Ù‡ Ø¯Ø± ØªØµØ§ÙˆÛŒØ± Ø´ÙØ§Ù (Ù…Ø«Ù„ PNG)
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, size, size);

    const imgAspectRatio = userImg.naturalWidth / userImg.naturalHeight;
    let drawWidth = size, drawHeight = size, x = 0, y = 0;
    if (imgAspectRatio > 1) {
        drawHeight = size; drawWidth = drawHeight * imgAspectRatio; x = (size - drawWidth) / 2;
    } else {
        drawWidth = size; drawHeight = drawWidth / imgAspectRatio; y = (size - drawHeight) / 2;
    }
    ctx.drawImage(userImg, x, y, drawWidth, drawHeight);
    ctx.drawImage(frameImg, 0, 0, size, size);
    
    // <<< ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ >>>
    // Ø¨Ù‡ Ø¬Ø§ÛŒ toBlob(resolve, 'image/png')ØŒ Ø§Ø² image/jpeg Ø¨Ø§ Ú©ÛŒÙÛŒØª 90% Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.90)); 
}

        
async function uploadBlobToBaleViaWorker(imageBlob) {
    outputDiv.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±...";

    try {
        // --- Ø´Ø±ÙˆØ¹ ØªØºÛŒÛŒØ±Ø§Øª ---
        // 1. Ø³Ø§Ø®Øª ÛŒÚ© URL Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ø´Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        const uniqueWorkerUrl = `${workerUrl}?v=${Date.now()}`;
        // --- Ù¾Ø§ÛŒØ§Ù† ØªØºÛŒÛŒØ±Ø§Øª ---

        const timestamp = Date.now();
        const fileName = `Parcham-Bala-${timestamp}.jpg`;
        const formData = new FormData();
        formData.append("file", imageBlob, fileName);

        // 2. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² URL Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª fetch
        const response = await fetch(uniqueWorkerUrl, {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.details || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
        }
        
        if (result.error) {
            throw new Error(result.error);
        }

        outputDiv.innerHTML = `<p class="success">âœ… ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.</p>`;
        
        const downloadUrl = result.url;

        // finalLinkContainer.innerHTML = `
        //     <a href="${downloadUrl}" class="action-button" download="${fileName}">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… ØªØµÙˆÛŒØ±</a>
        // `;
        document.getElementById("final-link").innerHTML = `<a href="${downloadUrl}" target="_blank" class="action-button">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</a>`;
        
        if (isEitaaEnv) {
            EitaaApp.MainButton.setText("Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±");
            EitaaApp.MainButton.onClick(() => EitaaApp.openLink(downloadUrl));
            EitaaApp.MainButton.show();
        }

        restartButton.style.display = 'inline-block';

    } catch (error) {
         outputDiv.innerHTML = `<p class="error">âŒ ${error.message}</p>`;
         restartButton.style.display = 'block';
    }
}


        function resetApp() {
            userFile = null;
            finalImageBlob = null;
            if(previewImage.src) URL.revokeObjectURL(previewImage.src);

            fileInput.value = '';
            selectionArea.style.display = 'block';
            uploadLabel.style.display = 'inline-block';
            frameSelectionDiv.style.display = 'none';
            frameSelectionDiv.innerHTML = '';
            previewContainer.style.display = 'none';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<p>Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§...</p>';
            finalLinkContainer.innerHTML = '';
            restartButton.style.display = 'none';

            if (isEitaaEnv) {
                EitaaApp.MainButton.hide();
            }
        }
    });
    </script>
</body>
</html>
